---
version: 2.1

quality_gem_version: &quality_gem_version "39"

orbs:
  quality: bluelabs/quality@0.0.2

commands:
  run_with_languages:
    description: "Run the given command in an environment that includes relevant langauges in the PATH"
    parameters:
      command:
        type: string
        description: "What command to execute"
      label:
        type: string
        description: "What to label the run"
        default: <<parameters.command>>
    steps:
      - run:
          name: <<parameters.label>>
          command: |
            export PATH="${HOME}/.pyenv/bin:${PATH}"
            export PATH="${HOME}/.rbenv/bin:${HOME}/.rbenv/shims:${PATH}"
            export PATH="${HOME}/project/node_modules/.bin:${PATH}"
            eval "$(pyenv init --path)"
            eval "$(pyenv virtualenv-init -)"
            eval "$(rbenv init -)"
            export BUNDLE_PATH=vendor/bundle

            <<parameters.command>>
          environment:
            # https://app.circleci.com/pipelines/github/apiology/cookiecutter-pypackage/4/workflows/29074dc8-944c-4600-8aaa-5116575fed90/jobs/4
            "LC_ALL": "C.UTF-8"
            "LANG": "C.UTF-8"
  set_up_environment:
    description: "Install source environment"
    steps:
      - checkout
      - run: |
          sed -E -e 's/quality \([[:digit:]]+.[[:digit:]]+.[[:digit:]]+\)/quality (0.1.0)/g' \
          Gemfile.lock > Gemfile.lock.deversioned
      - restore_cache:
          key: gems-v1-{{ checksum "Gemfile.lock.deversioned" }}
      - restore_cache:
          key: wheels-v1-{{ checksum "requirements_dev.txt" }}
      - run:
          name: Initialize packages
          command: |
            export BUNDLE_PATH=vendor/bundle
            './fix.sh'
      - run:
          name: Verify Gemfile.lock
          command: |
            if ! git diff --exit-code Gemfile.lock
            then
              >&2 echo "Please resolve changes to Gemfile.lock after bundle install to avoid caching difficulties"
              exit 1
            fi
      - save_cache:
          key: gems-v1-{{ checksum "Gemfile.lock.deversioned" }}
          paths:
            - "vendor/bundle"
      - save_cache:
          key: wheels-v1-{{ checksum "requirements_dev.txt" }}
          paths:
            - "/home/circleci/.cache/pip/wheels"
      - run:
          name: Download new circleci tool
          command: |
            curl -fLSs \
            https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | sudo bash

jobs:
  overcommit:
    docker:
      - image: apiology/circleci-ruby:latest
    steps:
      - when:
          condition:
            equal: [<< pipeline.git.branch >>, "main"]
          steps:
            - overcommit
      - unless:
          condition:
            equal: [<< pipeline.git.branch >>, "main"]
          steps:
            - run: echo "overcommit only runs on main branch"
  build:
    working_directory: ~/quality
    docker:
      - image: apiology/circleci-ruby:latest
    environment:
      BUNDLE_PATH: '/home/circleci/vendor/bundle'
    steps:
      - set_up_environment
      - run_with_languages:
          label: Test
          command: |
            bundle exec rake citest
            # https://github.com/bluelabsio/records-mover/blob/master/Makefile#L25
            git status --porcelain coverage/.last_run.json
            git diff coverage/.last_run.json
            test -z "$(git status --porcelain coverage/.last_run.json)"
    # This seemed to shave 5ish% of the build time off when added
    resource_class: large

workflows:
  version: 2
  weekly:
    triggers:
      - schedule:
          cron: "0 0 * * 6"
          filters:
            branches:
              only:
                - main
    jobs:
      - build
      - quality/check-quality-job:
          custom_rakefile: rakelib/quality.rake
          image_tag: *quality_gem_version
  quality:
    #    when:
    #      equal: [<< pipeline.git.branch >>, "main"]
    jobs:
      - quality/check-quality-job:
          custom_rakefile: rakelib/quality.rake
          image_tag: *quality_gem_version
  build:
    jobs:
      - build
